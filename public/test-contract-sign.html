<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Assinatura de Contrato</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Assinatura de Contrato</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Este script deve ser executado ap√≥s fazer login no sistema. 
            Voc√™ precisa estar autenticado como Gestor ou Assessor.
        </div>

        <div class="info">
            <strong>‚ÑπÔ∏è INSTRU√á√ïES:</strong>
            <ol>
                <li>Fa√ßa login no sistema (Gestor ou Assessor)</li>
                <li>Abra o DevTools (F12) e v√° para a aba Console</li>
                <li>Copie e cole o script JavaScript abaixo</li>
                <li>Substitua os valores conforme necess√°rio</li>
                <li>Execute o script</li>
            </ol>
        </div>

        <h2>üìù Par√¢metros do Teste</h2>
        <label>Lead ID:</label>
        <input type="number" id="leadId" value="1" placeholder="ID do Lead">
        
        <label>Contract ID:</label>
        <input type="number" id="contractId" value="1" placeholder="ID do Contrato">
        
        <label>Assinado por:</label>
        <input type="text" id="signedBy" value="Cliente de Teste" placeholder="Nome do signat√°rio">
        
        <label>Mover Lead para:</label>
        <select id="moveLeadStatus">
            <option value="client">Cliente (Sucesso)</option>
            <option value="lost">Perdido (Falha)</option>
            <option value="">N√£o mover</option>
        </select>

        <h2>üöÄ Script JavaScript para Console</h2>
        <p>Copie e cole este script no Console do navegador (F12):</p>
        <div class="code-block" id="scriptOutput"></div>
        
        <button onclick="generateScript()">üîÑ Gerar Script</button>
        <button onclick="copyScript()">üìã Copiar Script</button>
        <button class="danger" onclick="executeTest()">‚ñ∂Ô∏è Executar Teste (Direto)</button>

        <h2>üìä Resultado Esperado</h2>
        <div class="info">
            <strong>Fluxo de Sucesso (client):</strong>
            <ul>
                <li>‚úÖ Contrato.status = 'Assinado'</li>
                <li>‚úÖ Contrato.signed_by = valor informado</li>
                <li>‚úÖ Contrato.signed_at = data/hora atual</li>
                <li>‚úÖ Lead.is_won = true</li>
                <li>‚úÖ Lead.pipeline_stage_id = 'Cliente Ativo'</li>
                <li>‚úÖ PDF gerado e email enviado</li>
            </ul>
            
            <strong>Fluxo de Perda (lost):</strong>
            <ul>
                <li>‚úÖ Contrato.status = 'Cancelado'</li>
                <li>‚úÖ Lead.is_won = false</li>
                <li>‚úÖ Lead.pipeline_stage_id = 'Cliente Perdido'</li>
                <li>‚ùå PDF/Email N√ÉO s√£o gerados</li>
            </ul>
        </div>
    </div>

    <script>
        function generateScript() {
            const leadId = document.getElementById('leadId').value;
            const contractId = document.getElementById('contractId').value;
            const signedBy = document.getElementById('signedBy').value;
            const moveLeadStatus = document.getElementById('moveLeadStatus').value;
            
            // Obter CSRF token da p√°gina atual (se dispon√≠vel)
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                             document.querySelector('input[name="_token"]')?.value || 
                             'COLE_O_SEU_TOKEN_AQUI';
            
            const script = `/*
 * SCRIPT DE TESTE: Assinatura de Contrato
 * Execute este script no Console do navegador (F12)
 */

// üö® SUBSTITUA O TOKEN CSRF SE NECESS√ÅRIO üö®
const csrfToken = '${csrfToken}';

// --- DADOS DA A√á√ÉO ---
const leadId = ${leadId};
const contractId = ${contractId};
const targetUrl = \`/leads/\${leadId}/contract/\${contractId}/sign\`;
const signedByValue = '${signedBy}';
const moveLeadStatus = '${moveLeadStatus || ''}';

// 1. Cria um formul√°rio tempor√°rio no DOM
const form = document.createElement('form');
form.method = 'POST';
form.action = targetUrl;

// Fun√ß√£o auxiliar para criar campos ocultos
function createHiddenField(name, value) {
    const field = document.createElement('input');
    field.type = 'hidden';
    field.name = name;
    field.value = value;
    return field;
}

// 2. Adiciona os campos obrigat√≥rios
form.appendChild(createHiddenField('_token', csrfToken));
form.appendChild(createHiddenField('signed_by', signedByValue));
${moveLeadStatus ? `form.appendChild(createHiddenField('move_lead_status', moveLeadStatus));` : ''}

// 3. Envia o formul√°rio
document.body.appendChild(form);
form.submit();

console.log('‚úÖ POST enviado para:', targetUrl);
console.log('üìã Par√¢metros:', { signed_by: signedByValue, move_lead_status: '${moveLeadStatus || 'n√£o informado'}' });
console.log('üîç Verifique o banco de dados para confirmar as altera√ß√µes.');`;

            document.getElementById('scriptOutput').textContent = script;
        }

        function copyScript() {
            const scriptText = document.getElementById('scriptOutput').textContent;
            navigator.clipboard.writeText(scriptText).then(() => {
                alert('‚úÖ Script copiado para a √°rea de transfer√™ncia!');
            }).catch(() => {
                alert('‚ùå Erro ao copiar. Selecione o texto manualmente.');
            });
        }

        function executeTest() {
            const leadId = document.getElementById('leadId').value;
            const contractId = document.getElementById('contractId').value;
            const signedBy = document.getElementById('signedBy').value;
            const moveLeadStatus = document.getElementById('moveLeadStatus').value;
            
            // Obter CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                             document.querySelector('input[name="_token"]')?.value;
            
            if (!csrfToken) {
                alert('‚ùå Token CSRF n√£o encontrado! Fa√ßa login e acesse uma p√°gina do sistema primeiro.');
                return;
            }
            
            const targetUrl = `/leads/${leadId}/contract/${contractId}/sign`;
            
            // Criar formul√°rio
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = targetUrl;
            
            // Adicionar campos
            const tokenField = document.createElement('input');
            tokenField.type = 'hidden';
            tokenField.name = '_token';
            tokenField.value = csrfToken;
            form.appendChild(tokenField);
            
            const signedByField = document.createElement('input');
            signedByField.type = 'hidden';
            signedByField.name = 'signed_by';
            signedByField.value = signedBy;
            form.appendChild(signedByField);
            
            if (moveLeadStatus) {
                const moveField = document.createElement('input');
                moveField.type = 'hidden';
                moveField.name = 'move_lead_status';
                moveField.value = moveLeadStatus;
                form.appendChild(moveField);
            }
            
            // Enviar
            document.body.appendChild(form);
            form.submit();
        }

        // Gerar script inicial
        generateScript();
    </script>
</body>
</html>

